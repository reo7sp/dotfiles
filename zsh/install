#!/bin/bash
set -e -o pipefail

key=$1
if [[ $key == "-q" ]]; then
  QUICK_INSTALL=1
else
  QUICK_INSTALL=0
fi

confirm() {
  local message=$1

  if [[ $QUICK_INSTALL == 1 ]]; then
    false
  else
    echo -n -e "${BWhite}$message${Color_Off} [y/N] "
    read response
    case $response in
      [yY][eE][sS]|[yY])
        true
        ;;
      *)
        false
        ;;
    esac
  fi
}


if [ ! -d ~/.antidote ]; then
  git clone --depth=1 https://github.com/mattmc3/antidote.git ${ZDOTDIR:-~}/.antidote
fi

if [ -f ~/.zshrc ]; then
  if confirm "Do you want to overwrite ~/.zshrc?"; then
    cp zshrc ~/.zshrc
  fi
else
  cp zshrc ~/.zshrc
fi
cp my.zshrc ~/.my.zshrc
cp zsh_plugins.txt ~/.zsh_plugins.txt
cp p10k.zsh ~/.p10k.zsh
mkdir -p ~/.config/fsh
cp overlay.ini ~/.config/fsh/overlay.ini
zsh -c '
  source ~/.antidote/antidote.zsh
  eval "$(antidote bundle catppuccin/zsh-fsh kind:path)" >/dev/null 2>&1
  FSTHEME_DIR="$HOME/.config/fsh"
  CATPPUCCIN_BUNDLE="$(antidote path catppuccin/zsh-fsh 2>/dev/null)/themes"
  if [[ -n "$CATPPUCCIN_BUNDLE" && -d "$CATPPUCCIN_BUNDLE" ]]; then
    mkdir -p "$FSTHEME_DIR"
    ln -sf "$CATPPUCCIN_BUNDLE"/catppuccin-*.ini "$FSTHEME_DIR"/
  fi
  eval "$(antidote bundle zdharma-continuum/fast-syntax-highlighting)" >/dev/null 2>&1
  fast-theme -r 2>/dev/null; fast-theme XDG:catppuccin-latte 2>/dev/null
' || true
mkdir -p ~/bin
cp bin/strip-whitespace ~/bin/strip-whitespace
mkdir -p ~/.config/direnv
cp direnvrc ~/.config/direnv/direnvrc
cp direnv.toml ~/.config/direnv/direnv.toml
